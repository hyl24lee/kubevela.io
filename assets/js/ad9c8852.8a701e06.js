(self.webpackChunkkubevela_io=self.webpackChunkkubevela_io||[]).push([[30800],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return s},kt:function(){return c}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),m=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},s=function(e){var t=m(e.components);return a.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,p=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),d=m(n),c=r,k=d["".concat(p,".").concat(c)]||d[c]||u[c]||l;return n?a.createElement(k,i(i({ref:t},s),{},{components:n})):a.createElement(k,i({ref:t},s))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=d;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var m=2;m<l;m++)i[m]=n[m];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},23786:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return i},metadata:function(){return o},toc:function(){return p},default:function(){return s}});var a=n(22122),r=n(19756),l=(n(67294),n(3905)),i={title:"Kustomize"},o={unversionedId:"end-user/components/kustomize",id:"end-user/components/kustomize",isDocsHomePage:!1,title:"Kustomize",description:"Create a Kustomize Component, it could be from Git Repo or OSS bucket or image registry.",source:"@site/docs/end-user/components/kustomize.md",sourceDirName:"end-user/components",slug:"/end-user/components/kustomize",permalink:"/docs/next/end-user/components/kustomize",editUrl:"https://github.com/oam-dev/kubevela.io/edit/main/docs/end-user/components/kustomize.md",version:"current",lastUpdatedBy:"Tianxin Dong",lastUpdatedAt:1634611437,formattedLastUpdatedAt:"10/19/2021",frontMatter:{title:"Kustomize"},sidebar:"docs",previous:{title:"Helm",permalink:"/docs/next/end-user/components/helm"},next:{title:"Alibaba Cloud ACK",permalink:"/docs/next/end-user/components/cloud-services/terraform/alibaba-ack"}},p=[{value:"Watch Files",id:"watch-files",children:[{value:"Deploy From OSS bucket",id:"deploy-from-oss-bucket",children:[]},{value:"Deploy From Git Repo",id:"deploy-from-git-repo",children:[]}]},{value:"Watch Image Registry",id:"watch-image-registry",children:[]}],m={toc:p};function s(e){var t=e.components,n=(0,r.Z)(e,["components"]);return(0,l.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"Create a Kustomize Component, it could be from Git Repo or OSS bucket or image registry."),(0,l.kt)("h2",{id:"watch-files"},"Watch Files"),(0,l.kt)("h3",{id:"deploy-from-oss-bucket"},"Deploy From OSS bucket"),(0,l.kt)("p",null,"KubeVela's ",(0,l.kt)("inlineCode",{parentName:"p"},"kustomize")," component meets the needs of users to directly connect Yaml files and folders as component products. No matter whether your Yaml file/folder is stored in a Git Repo or an OSS bucket, KubeVela can read and deliver it."),(0,l.kt)("p",null,"Let's take the YAML folder component from the OSS bucket registry as an example to explain the usage. In the ",(0,l.kt)("inlineCode",{parentName:"p"},"Application")," this time, I hope to deliver a component named bucket-comp. The deployment file corresponding to the component is stored in the cloud storage OSS bucket, and the corresponding bucket name is definition-registry. ",(0,l.kt)("inlineCode",{parentName:"p"},"kustomize.yaml")," comes from this address of oss-cn-beijing.aliyuncs.com and the path is ",(0,l.kt)("inlineCode",{parentName:"p"},"./app/prod/"),"."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"(Optional) If your OSS bucket needs identity verification, create a Secret:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl create secret generic bucket-secret --from-literal=accesskey=<your-ak> --from-literal=secretkey=<your-sk>\nsecret/bucket-secret created\n")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"Deploy it:")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"cat <<EOF | kubectl apply -f -\napiVersion: core.oam.dev/v1beta1\nkind: Application\nmetadata:\n  name: bucket-app\nspec:\n  components:\n    - name: bucket-comp\n      type: kustomize\n      properties:\n        repoType: oss\n        # If the bucket is private, you will need to provide\n        secretRef: bucket-secret\n        url: oss-cn-beijing.aliyuncs.com\n        oss:\n          bucketName: definition-registry\n        path: ./app/prod/\nEOF\n")),(0,l.kt)("p",null,"Please copy the above code block and deploy it directly to the runtime cluster:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"application.core.oam.dev/bucket-app created\n")),(0,l.kt)("p",null,"Finally, we use ",(0,l.kt)("inlineCode",{parentName:"p"},"vela ls")," to view the application status after successful delivery:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"vela ls\nAPP                     COMPONENT   TYPE        TRAITS  PHASE   HEALTHY STATUS  CREATED-TIME                 \nbucket-app              bucket-comp kustomize           running healthy         2021-08-28 18:53:14 +0800 CST\n")),(0,l.kt)("p",null,"The PHASE of the app is running, and the STATUS is healthy. Successful application deployment!"),(0,l.kt)("h4",{id:"attributes"},"Attributes"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Parameters"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Example"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"repoType"),(0,l.kt)("td",{parentName:"tr",align:null},"required, The value of the Git. To indicate that kustomize configuration comes from the Git repository"),(0,l.kt)("td",{parentName:"tr",align:null},"oss")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"pullInterval"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, Synchronize with Git repository, and the time interval between tuning helm release. The default value is 5m (5 minutes\uff09"),(0,l.kt)("td",{parentName:"tr",align:null},"10m")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"url"),(0,l.kt)("td",{parentName:"tr",align:null},"required, bucket's endpoint, no need to fill in with scheme"),(0,l.kt)("td",{parentName:"tr",align:null},"oss-cn-beijing.aliyuncs.com")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"secretRef"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, Save the name of a Secret, which is the credential to read the bucket. Secret contains accesskey and secretkey fields"),(0,l.kt)("td",{parentName:"tr",align:null},"sec-name")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"timeout"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, The timeout period of the download operation, the default is 20s"),(0,l.kt)("td",{parentName:"tr",align:null},"60s")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"path"),(0,l.kt)("td",{parentName:"tr",align:null},"required, The directory containing the kustomization.yaml file, or the directory containing a set of YAML files (used to generate kustomization.yaml)"),(0,l.kt)("td",{parentName:"tr",align:null},"./prod")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"oss.bucketName"),(0,l.kt)("td",{parentName:"tr",align:null},"required, bucket name"),(0,l.kt)("td",{parentName:"tr",align:null},"your-bucket")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"oss.provider"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, Generic or aws, if you get the certificate from aws EC2, fill in aws. The default is generic."),(0,l.kt)("td",{parentName:"tr",align:null},"generic")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"oss.region"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, bucket region"),(0,l.kt)("td",{parentName:"tr",align:null})))),(0,l.kt)("h3",{id:"deploy-from-git-repo"},"Deploy From Git Repo"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Parameters"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Example"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"repoType"),(0,l.kt)("td",{parentName:"tr",align:null},"required, The value of the Git. To indicate that kustomize configuration comes from the Git repository"),(0,l.kt)("td",{parentName:"tr",align:null},"git")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"pullInterval"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, Synchronize with Git repository, and the time interval between tuning helm release. The default value is 5m (5 minutes\uff09"),(0,l.kt)("td",{parentName:"tr",align:null},"10m")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"url"),(0,l.kt)("td",{parentName:"tr",align:null},"required, Git repository address"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("a",{parentName:"td",href:"https://github.com/oam-dev/terraform-controller"},"https://github.com/oam-dev/terraform-controller"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"secretRef"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, The Secret object name that holds the credentials required to pull the Git repository. The username and password fields must be included in the HTTP/S basic authentication Secret. For SSH authentication, the identity, identity.pub and known_hosts fields must be included"),(0,l.kt)("td",{parentName:"tr",align:null},"sec-name")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"timeout"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, The timeout period of the download operation, the default is 20s"),(0,l.kt)("td",{parentName:"tr",align:null},"60s")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"git.branch"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, Git branch, master by default"),(0,l.kt)("td",{parentName:"tr",align:null},"dev")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"git.provider"),(0,l.kt)("td",{parentName:"tr",align:null},"optional, Determines which git client library to use. Defaults to GitHub, it will pick go-git. AzureDevOps will pick libgit2"),(0,l.kt)("td",{parentName:"tr",align:null},"GitHub")))),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"How-to")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: core.oam.dev/v1beta1\nkind: Application\nmetadata:\n  name: git-app\nspec:\n  components:\n    - name: git-comp\n      type: kustomize\n      properties:\n        repoType: git\n        url: https://github.com/<path>/<to>/<repo>\n        git:\n          branch: master\n          provider: GitHub\n        path: ./app/dev/\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Override Kustomize")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: core.oam.dev/v1beta1\nkind: Application\nmetadata:\n  name: bucket-app\nspec:\n  components:\n    - name: bucket-comp\n      type: kustomize\n      properties:\n        # ...omitted for brevity\n        path: ./app/\n     \n")),(0,l.kt)("h2",{id:"watch-image-registry"},"Watch Image Registry"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,l.kt)("th",{parentName:"tr",align:null},"Required"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Example"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"image"),(0,l.kt)("td",{parentName:"tr",align:null},"required"),(0,l.kt)("td",{parentName:"tr",align:null},"The image url"),(0,l.kt)("td",{parentName:"tr",align:null},"oamdev/vela-core")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"secretRef"),(0,l.kt)("td",{parentName:"tr",align:null},"optional"),(0,l.kt)("td",{parentName:"tr",align:null},"If it's a private image registry, use ",(0,l.kt)("inlineCode",{parentName:"td"},"kubectl create secret docker-registry")," to create the secret"),(0,l.kt)("td",{parentName:"tr",align:null},"my-secret")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"policy.alphabetical.order"),(0,l.kt)("td",{parentName:"tr",align:null},"optional"),(0,l.kt)("td",{parentName:"tr",align:null},"Order specifies the sorting order of the tags. Given the letters of the alphabet as tags, ascending order would select Z, and descending order would select A"),(0,l.kt)("td",{parentName:"tr",align:null},"asc")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"policy.numerical.order"),(0,l.kt)("td",{parentName:"tr",align:null},"optional"),(0,l.kt)("td",{parentName:"tr",align:null},"Given the integer values from 0 to 9 as tags, ascending order would select 9, and descending order would select 0"),(0,l.kt)("td",{parentName:"tr",align:null},"asc")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"policy.semver.range"),(0,l.kt)("td",{parentName:"tr",align:null},"optional"),(0,l.kt)("td",{parentName:"tr",align:null},"Range gives a semver range for the image tag; the highest version within the range that's a tag yields the latest image"),(0,l.kt)("td",{parentName:"tr",align:null},"'>=1.0.0 <2.0.0'")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"filterTags.extract"),(0,l.kt)("td",{parentName:"tr",align:null},"optional"),(0,l.kt)("td",{parentName:"tr",align:null},"Extract allows a capture group to be extracted from the specified regular expression pattern, useful before tag evaluation"),(0,l.kt)("td",{parentName:"tr",align:null},"$timestamp")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"filterTags.pattern"),(0,l.kt)("td",{parentName:"tr",align:null},"optional"),(0,l.kt)("td",{parentName:"tr",align:null},"Pattern specifies a regular expression pattern used to filter for image tags"),(0,l.kt)("td",{parentName:"tr",align:null},"'^master-","[a-f0-9]","'")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"commitMessage"),(0,l.kt)("td",{parentName:"tr",align:null},"optional"),(0,l.kt)("td",{parentName:"tr",align:null},"Use for more commit message"),(0,l.kt)("td",{parentName:"tr",align:null},"'Image: {{range .Updated.Images}}{{println .}}{{end}}'")))),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Example")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: core.oam.dev/v1beta1\nkind: Application\nmetadata:\n  name: image-app\nspec:\n  components:\n    - name: image\n      type: kustomize\n      properties:\n        imageRepository:\n          image: <your image>\n          secretRef: imagesecret\n          filterTags:\n            pattern: '^master-[a-f0-9]+-(?P<ts>[0-9]+)'\n            extract: '$ts'\n          policy:\n            numerical:\n              order: asc\n          commitMessage: \"Image: {{range .Updated.Images}}{{println .}}{{end}}\"\n")))}s.isMDXComponent=!0}}]);